# Unpack
execute_process(COMMAND "@CMAKE_COMMAND@" -E tar xjf "@CMAKE_CURRENT_SOURCE_DIR@/hawaii-c.tar.bz2" WORKING_DIRECTORY "@CMAKE_CURRENT_BINARY_DIR@")

# Run the converter
execute_process(COMMAND "@CMAKE_BINARY_DIR@/bin/dem-g" "@CMAKE_CURRENT_BINARY_DIR@/hawaii-c" OUTPUT_VARIABLE dem_g_log ERROR_VARIABLE dem_g_log)
file(WRITE "@CMAKE_CURRENT_BINARY_DIR@/hawaii-c.log" "${dem_g_log}")

# Known "good" md5sum of output for comparision
set(EXPECTED_MD5 "cf87c3b174840f18f5653c677af1f433")

# get and clean up md5sum from generated output
execute_process(COMMAND "@CMAKE_COMMAND@" -E md5sum "@CMAKE_CURRENT_BINARY_DIR@/hawaii-c.dsp" OUTPUT_VARIABLE genmd5)
string(REPLACE " @CMAKE_CURRENT_BINARY_DIR@/hawaii-c.dsp" "" genmd5 "${genmd5}")
string(STRIP "${genmd5}" genmd5)

# Check md5sum for a match
if("${EXPECTED_MD5}" STREQUAL "${genmd5}")
  execute_process(COMMAND "@CMAKE_COMMAND@" -E touch "@CMAKE_CURRENT_BINARY_DIR@/hawaii-c.done")
else("${EXPECTED_MD5}" STREQUAL "${genmd5}")
  file(APPEND "@CMAKE_CURRENT_BINARY_DIR@/hawaii-c.log" "\n\ndem results differ for @CMAKE_CURRENT_BINARY_DIR@/hawaii-c.dsp: expected ${EXPECTED_MD5}, got ${genmd5}")
  message(FATAL_ERROR "[dem-g] Failure while converting @CMAKE_CURRENT_BINARY_DIR@/hawaii-c, see @CMAKE_CURRENT_BINARY_DIR@/hawaii-c.log for more info.\n")
endif("${EXPECTED_MD5}" STREQUAL "${genmd5}")

# Local Variables:
# tab-width: 8
# mode: cmake
# indent-tabs-mode: t
# End:
# ex: shiftwidth=2 tabstop=8

